# 4장. 커넥션 관리
## 4.1 TCP 커넥션
모든 통신은 TCP/IP 를 통하여 이루어짐

### TCP는
- HTTP 에게 신뢰할 만한 통신 방식을 제공한다.


### 4.1.2 TCP 스트림은 세그먼트로 나뉘어 IP 패킷을 통해 전송된다
* IP 패킷이라고 불리는 작은 조각을 통해 데이터를 전송한다.
* HTTPS는 `TLS`, `SSL` 이라 불리기도 한다. TCP와 HTTP 사이에 있는 암호화 계층(보안 계층)이다.

#### HTTP가 메세지를 전송할 때, TCP/IP 소프트 웨어에 의해 처리되는 전달 과정
- 현재 연결된 TCP 커넥션을 통해서 메시지 데이터의 내용을 순서대로 보낸다.
- TCP는 세그먼트라는 단위로 데이터 스트림을 나누고
- IP패킷이라고 불리는 봉투에 담아서
- 인터넷을 통해 데이터를 전달

#### IP 패킷
- IP 패킷 헤더 (보통 20byte)
- TCP 세그먼트 헤더 (보통 20byte)
- TCP 데이터 조각 (0 ~ N)

-> IP 패킷은 TCP 데이터 스트림 덩어리를 운반하는 TCP 세그먼트를 실어 나른다.
(88p, 그림 4-4 참조)


### 4.1.3 커넥션 유지하기
포트 번호를 통해서 여러개의 커넥션을 유지한다.

#### 유일한 커넥션 식별
```
<발신지 IP주소, 발신지 포트, 수신지 IP주소, 수신지 포트>
```


### 4.1.4 TCP 소켓 프로그래밍
- 운영체제가 제공하는 소켓 API
- 대부분의 운영체제와 언어에서 소켓 API 구현체를 가지고 있음
- TCP 종단(endpoint) 데이터 구조 생성
- 원격서버의 TCP 종단에 종단 데이터 구조를 연결하여 데이터 스트림을 읽고 쓸 수 있다.
- 기본적인 네트워크 프로토콜의 핸드셰이킹, TCP 데이터 스트림과 IP 패킷 간의 분할 및 재조립에 대한 모든 세부사항을 외부로부터 숨긴다.

![[IMG_0651.jpg]]


## 4.2 TCP의 성능에 대한 고려
HTTP 트랜잭션의 성능은 TCP 성능에 영향을 받는다.

### 4.2.1 HTTP 트랜잭션 지연
![[IMG_0652.jpg]]
그림과 같이 HTTP 지연은 TCP 네트워크 지연 때문에 발생하는 경우가 대부분이다.

1. 호스트명 -> IP 주소로 변환하는 DNS 과정에서 시간 소요
2. 서버의 커넥션 허가 응답을 기다림. 새로운 TCP 커넥션에서 항상 발생
3. HTTP 요청을 TCP 파이프로 전송, 서버에 의해 처리
4. 웹서버가 응답

> 네트워크 지연 영향
`하드웨어 성능`  `네트워크와 서버의 전송 속도`  `요청과 응답 메세지의 크기`  `클라이언트와 서버간의 거리` 
`TCP 프로토콜의 기술적인 복잡성`

### 4.2.2 성능 중요 요소
성능상의 문제 뿐만 아니라 HTTP 프로그래머에게 영향을 주는 가장 일반적인 TCP 관련 지연들

- TCP 커넥션의 핸드셰이크 설정
- 인터넷 혼잡을 제어하기 위한 TCP의 느린 시작 (slow-start)
- 데이터를 한데 모아 한 번에 전송하기 위한 네이글(nagle) 알고리즘
- TCP의 편승(piggyback) 확인응답(acknowledgment)을 위한 확인 응답 지연 알고리즘
- TIME_WALT 지연과 포트 고갈

### 4.2.3 핸드셰이크 지연
커넥션 열 때, 조건을 맞추기 위해 연속으로 IP 패킷을 교환한다.
_이 때 **작은 크기의 데이터**로 사용된다면, 성능을 저하시킬 수 있다._

> TCP 커넥션 헨드셰이크 순서
1. 커넥션 생성을 위해 작은 TCP 패킷을 서버에 보낸다. -> `SYN`  플래그 포함 ('요청이 커넥션 생성 요청'이라는 의미를 가짐)
2. 서버: 몇 가지 커넥션 매개변수를 산출 -> `SYN` 과 `ACK` 플래그를 포함한 TCP 패킷을 클라이언트에게 응답
3. 클라이언트는 커넥션이 잘 맺어졌음을 알리기 위해 서버에게 확인응답 신호를 전달 -> `ACK` 와 http 메시지

HTTP 프로그래머는 이 과정을 보지 못한다. **TCP 소프트웨어가 관리**

<u>크기가 작은 HTTP 트랜잭션</u>은 -> 50% 이상의 시간을 TCP를 구성하는데 쓴다.


### 4.2.4 확인 응답 지연



-----
### 👀
1. (86p) 웹브라우저가 TCP 커넥션을 통하여 웹서버에 요청을 보내는 과정 -> (?) 1~3단계의 자세한 과정
	- IP 와 포트번호를 찾고 얻는건 브라우저가 한다. 그 과정은..?
	- DNS와 관련이 있을까?
